import cv2
from ultralytics import YOLO

model = YOLO("yolov8s.pt")

# ===== Tự động lấy danh sách class phương tiện từ mô hình =====
def is_vehicle(class_name):
    class_name = class_name.lower()
    VEHICLE_KEYWORDS = ["car", "truck", "bus", "motor", "bike"]
    return any(k in class_name for k in VEHICLE_KEYWORDS)

def get_density(num_vehicles, w, h):
    return min(num_vehicles / 50.0, 1.0)

def classify_density(density):
    if density < 0.4:
        return "Giao thông thông thoáng"
    elif density < 0.8:
        return "Di chuyển chậm"
    return "Tắc nghẽn giao thông"

def process_image(image_path):
    img = cv2.imread(image_path)
    h, w = img.shape[:2]

    results = model.predict(img, conf=0.4)[0]

    count_vehicle = 0

    for box in results.boxes:
        cls_id = int(box.cls[0])
        cls_name = model.names[cls_id]

        if is_vehicle(cls_name):
            count_vehicle += 1
            x1, y1, x2, y2 = box.xyxy[0].cpu().numpy().astype(int)
            cv2.rectangle(img, (x1, y1), (x2, y2), (0, 255, 0), 2)
            cv2.putText(img, cls_name, (x1, y1 - 5),
                        cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0,255,0), 2)

    density = get_density(count_vehicle, w, h)
    state = classify_density(density)

    print(f"Số lượng phương tiện: {count_vehicle}")
    print(f"Mật độ giao thông: {density:.2f}")
    print(f"Trạng thái: {state}")

    cv2.putText(img, f"Vehicles: {count_vehicle}", (20, 40),
                cv2.FONT_HERSHEY_SIMPLEX, 1, (0,255,0), 3)
    cv2.putText(img, f"Density: {density:.2f}", (20, 80),
                cv2.FONT_HERSHEY_SIMPLEX, 1, (0,255,0), 3)
    cv2.putText(img, f"Traffic: {state}", (20, 120),
                cv2.FONT_HERSHEY_SIMPLEX, 1, (0,0,255), 3)

    out_path = "output_" + image_path
    cv2.imwrite(out_path, img)
    print(f"Ảnh đã lưu: {out_path}")

process_image("bus.jpg")
